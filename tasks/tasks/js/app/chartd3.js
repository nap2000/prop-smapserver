/*
 This file is part of SMAP.

 SMAP is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 uSMAP is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with SMAP.  If not, see <http://www.gnu.org/licenses/>.

 */

define(["jquery","modernizr","localise","globals","app/charts/bar_h","app/charts/bar_v","app/charts/pie","app/charts/line","app/charts/wordcloud","d3","svgsave"],function(e,t,n,a,r,o,s,i,l,c,u){function h(t,n){K||(localise.setlang(),e("#editChartSave").off().click(function(){E()}),e("#ew_tseries").off().change(function(){T(void 0,void 0),L()}),e("#ew_question1").off().change(function(){x(),L()}),e("#ew_chart_type").off().change(function(){L()}),e("#ew_fn").off().change(function(){L()}),K=!0,V='<option value="-1">'+localise.set.none+"</option>"),(G&&t||J&&n)&&f(t,n,!0)}function d(e){Z=e||[]}function p(t){var n,r,o,s,i=a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data(),l=[],c=i.count(),u=[];if(t){var h=gTasks.cache.currentData.schema.columns;for(n=0;n<h.length;n++)if(h[n].chartQuestion){if(o={title:h[n].select_name?h[n].select_name:h[n].displayName,tSeries:!1,chart_type:"other",fn:P(h[n].type),groups:[{name:h[n].select_name?h[n].select_name:h[n].displayName,dataLabel:h[n].select_name?h[n].select_name:h[n].displayName,l_id:h[n].l_id,type:h[n].type}]},"select"===h[n].type&&(o.groups[0].choiceNames=h[n].choiceNames,o.groups[0].choices=h[n].choices),(s=e("#srf_group").val())==n)continue;-1!=s&&(o.groups.push({name:h[s].select_name?h[s].select_name:h[s].displayName,dataLabel:h[s].select_name?h[s].select_name:h[s].displayName,l_id:h[s].l_id,type:h[s].type}),"select"!==h[s].type&&"select1"!==h[s].type||(o.groups[1].choiceNames=h[s].choiceNames,o.groups[1].choices=h[s].choices)),l.push(o)}}else l=Z;for(n=0;n<l.length;n++)o=l[n],r=y(i,o,c),v(u,o,r);return u}function f(t,n,r){var o;if(t||n){if(a.gMainTable){var s=a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data();for(gTasks.cache.surveyConfig[a.gViewId].processedData=void 0,r&&e(".aChart").remove(),o=0;o<Z.length;o++)g(s,Z[o],!1)}t?G=!1:n&&(J=!1)}else G=!0,J=!0}function m(e,t){g(a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data(),e,t)}function g(t,n,a){n.groups&&(n.groupDataNames=n.groups.map(function(e){return e.name}),n.dataLabels=n.groups.map(function(e){return e.dataLabel}));var r,o=t.count(),s=y(t,n,o),i=!1;n.id&&(r=e("#c_"+n.id),i=r.length),i&&a&&(r.remove(),i=!1),i||(n.id=N(n),r=e("#c_"+n.id)),b(r,s,n)}function v(e,t,n){var a,r,o,s,i=[];if(t.tSeries)a=n,!0;else if("wordcloud"===t.chart_type){!0;for(var l in n)n.hasOwnProperty(l)&&i.push({key:l,pr:[{key:t.groups[0].dataLabel,value:n[l]}]})}else{var u=n.length;if("percent"===t.fn&&0===u)return;var h={};if("percent"===t.fn){var d=c.nest().key(function(e){return e[t.groups[1].name]}).rollup(function(e){return e.length}).entries(n);for(r=0;r<d.length;r++)h["x"+d[r].key]=d[r].value}if(1===t.groups.length)a="count"===t.fn||"percent"===t.fn?c.nest().key(function(e){return e[t.groups[0].name]}).rollup(function(e){return"count"===t.fn?e.length:100*e.length/u}).entries(n):c.nest().key(function(e){return t.groups[0].name}).rollup(function(e){return"average"===t.fn?c.mean(e,function(e){return+e[t.groups[0].name]}):"sum"===t.fn?c.sum(e,function(e){return+e[t.groups[0].name]}):"min"===t.fn?c.min(e,function(e){return+e[t.groups[0].name]}):"max"===t.fn?c.max(e,function(e){return+e[t.groups[0].name]}):void 0}).entries(n);else if("count"===t.fn||"percent"===t.fn){if(a=c.nest().key(function(e){return e[t.groups[0].name]}).key(function(e){return e[t.groups[1].name]}).rollup(function(e){return e.length}).entries(n),"percent"===t.fn)for(r=0;r<a.length;r++)for(o=0;o<a[r].values.length;o++)0==h["x"+a[r].values[o].key]?a[r].values[o].value=0:a[r].values[o].value=100*a[r].values[o].value/h["x"+a[r].values[o].key]}else a=c.nest().key(function(e){return e[t.groups[1].name]}).rollup(function(e){return"average"===t.fn?c.mean(e,function(e){return+e[t.groups[0].name]}):"sum"===t.fn?c.sum(e,function(e){return+e[t.groups[0].name]}):"min"===t.fn?c.min(e,function(e){return+e[t.groups[0].name]}):"max"===t.fn?c.max(e,function(e){return+e[t.groups[0].name]}):void 0}).entries(n);var p=[];for(r=0;r<t.groups.length;r++)p.push(t.groups[r].dataLabel);var f=[];if(2===t.groups.length&&("count"===t.fn||"percent"===t.fn))for(r=0;r<a.length;r++)for(o=0;o<a[r].values.length;o++){var m=a[r].values[o].key;f.indexOf(m)<0&&f.push(m)}for(r=0;r<a.length;r++){var g={key:a[r].key,pr:[]};if((1===t.groups.length||"count"!==t.fn&&"percent"!==t.fn)&&g.pr.push({key:t.fn,value:a[r].value}),2===t.groups.length)for(o=0;o<f.length;o++){var v=!1;for(s=0;s<a[r].values.length;s++)if(a[r].values[s].key===f[o]){g.pr.push({key:f[o],value:a[r].values[s].value}),v=!0;break}v||g.pr.push({key:f[o],value:0})}i.push(g)}}var y={chart_type:t.chart_type,name:t.title,fn:t.fn,labels:p,columns:f,data:i};e.push(y)}function y(e,t,n){var a,r,o=gTasks.cache.currentData.schema.columns,s=t.qlabel?"label":"name";if(gTasks.cache.surveyConfig.processedData||(gTasks.cache.surveyConfig.processedData={}),t.tSeries)return _(e,t,n);if("wordcloud"===t.chart_type)return w(e,t,n);if("select"===t.groups[0].type||t.groups.length>1&&"select"===t.groups[1].type)return k(e,t,n);if(!gTasks.cache.surveyConfig.processedData[s])for(gTasks.cache.surveyConfig.processedData[s]=[],a=0;a<e.length;a++){var i={};for(i.count=1,r=0;r<o.length;r++){var l=e[a][o[r].column_name];o[r].l_id>0&&t.qlabel&&(l=M(o[r].l_id,l)),i[o[r].displayName]=l}i["Survey Duration"]||(i["Survey Duration"]=0),i["Survey Duration"]=+i["Survey Duration"],gTasks.cache.surveyConfig.processedData[s].push(i)}return gTasks.cache.surveyConfig.processedData[s]}function _(e,t,n){var a,r,o,s,i,l,u=[],h=c.timeParse("%Y-%m-%d %H:%M:%S%Z"),d=c.timeParse("%Y-%m-%d"),p=c.timeFormat("%Y-%m-%d"),f=c.timeParse("%Y-%m"),m=c.timeFormat("%Y-%m"),g=c.timeParse("%Y"),v=c.timeFormat("%Y"),y=[];for(l="count"===t.fn||"percent"===t.fn?"length":t.fn,"percent"!==t.fn&&1,t.tSeries?(o="day"===t.period?d:"month"===t.period?f:g,s="day"===t.period?p:"month"===t.period?m:v,i="day"===t.period?c.timeDay:"month"===t.period?c.timeMonth:c.timeYear):o=h,a=0;a<t.groups.length;a++)u.push(c.nest().key(function(e){var n,r,o;return e[t.groups[a].name]&&(n=e[t.groups[a].name].trim().split(" "),n.length>0&&(r=n[0],o=r.split("-"),"month"===t.period?r=o[0]+"-"+o[1]:"year"===t.period&&(r=o[0]))),r}).rollup(function(e){return e[l]}).entries(e));for(a=0;a<u.length;a++)u[a]=u[a].filter(function(e){return"undefined"!==e.key});for(a=0;a<u.length;a++)u[a].forEach(function(e){e.key=o(e.key)}),y[a]=u[a].reduce(function(e,t){if(t.key)return e[t.key.toISOString()]=t.value,e},{});var _=[];for(a=0;a<u.length;a++)_=_.concat(u[a]);r=c.extent(_.map(function(e){return e.key}));var w=i.range(r[0],i.offset(r[1],1)),k=[];return w.forEach(function(e){var n=e.toISOString();for(a=0;a<u.length;a++){var r=0,o={date:s(e)};if(n in y[a])r=y[a][n];else if("line"===t.chart_type)continue;o.count=r,o.group=t.groups[a].dataLabel,k.push(o)}}),k}function w(e,t,n){var a,r=e.map(function(e){return t.groups[0].l_id>0?M(t.groups[0].l_id,e[t.groups[0].name]):e[t.groups[0].name]}),o={};for(a=0;a<r.length;a++)if(r[a]){var s=r[a].split(/[ '\-\(\)\*":;\[\]|{},.!?]+/);1==s.length?o[s[0]]?o[s[0]]++:o[s[0]]=1:s.forEach(function(e){var e=e.toLowerCase();""!=e&&-1=="i,me,my,myself,we,us,our,ours,ourselves,you,your,yours,yourself,yourselves,he,him,his,himself,she,her,hers,herself,it,its,itself,they,them,their,theirs,themselves,what,which,who,whom,whose,this,that,these,those,am,is,are,was,were,be,been,being,have,has,had,having,do,does,did,doing,will,would,should,can,could,ought,i'm,you're,he's,she's,it's,we're,they're,i've,you've,we've,they've,i'd,you'd,he'd,she'd,we'd,they'd,i'll,you'll,he'll,she'll,we'll,they'll,isn't,aren't,wasn't,weren't,hasn't,haven't,hadn't,doesn't,don't,didn't,won't,wouldn't,shan't,shouldn't,can't,cannot,couldn't,mustn't,let's,that's,who's,what's,here's,there's,when's,where's,why's,how's,a,an,the,and,but,if,or,because,as,until,while,of,at,by,for,with,about,against,between,into,through,during,before,after,above,below,to,from,up,upon,down,in,out,on,off,over,under,again,further,then,once,here,there,when,where,why,how,all,any,both,each,few,more,most,other,some,such,no,nor,not,only,own,same,so,than,too,very,say,says,said,shall".indexOf(e)&&e.length>1&&(o[e]?o[e]++:o[e]=1)})}return o}function k(e,t,n){var a,r,o,s,i,l,c,u=[];t.groups,"select"==t.groups[0].type?(o=t.groups[0],t.groups.length>0&&(s=t.groups[1])):(s=t.groups[0],o=t.groups[1]);var h=gTasks.cache.currentData.schema.choiceLists;for(a=0;a<h.length;a++)if(h[a].l_id==o.l_id){h[a].choices;break}for(a=0;a<e.length;a++)if(e[a][o.dataLabel])for(c=e[a][o.dataLabel].split(" "),r=0;r<c.length;r++)i={count:1},l=t.qlabel?M(o.l_id,c[r]):c[r],i[o.dataLabel]=l,s&&(i[s.dataLabel]=e[a][s.dataLabel]),u.push(i);return u}function b(t,n,a){var r=e(".ibox-content",t).width(),o=e(".ibox-content",t).height();if(r>0&&o>0){var s=B[a.id];if(void 0===s&&(B[a.id]={},s=B[a.id],!0),A[a.chart_type]){s.domElement="#svg_"+a.id,e(s.domElement).length>0&&e(s.domElement).empty();var i=e(s.domElement),l=i.width(),c=i.height(),u=dimple.newSvg(s.domElement,l,c);"wordcloud"===a.chart_type?(s.svg=u,A[a.chart_type].draw.add(a,s,n,l,c)):(s.graph=new dimple.chart(u,n),A[a.chart_type].draw.add(a,s),s.graph.addLegend(l-150,10,100,c-20,"right"),s.graph.draw())}else console.log("unknown chart type: "+a.chart_type)}else alert("Could not find html for "+a.title)}function N(t){var n,a=(new Date).valueOf()+"_"+performance.now();n=a.replace(".","_");var r=[],o=-1;return r[++o]='<div class="aChart col-sm-',r[++o]=t.width?t.width:"6",r[++o]='" id="c_',r[++o]=n,r[++o]='">',r[++o]='<div class="ibox float-e-margins">',r[++o]='<div class="ibox-title">',r[++o]="<div><h5>",r[++o]=t.title,r[++o]="</h5></div>",r[++o]='<div class="ibox-tools"><a class="widget-edit" href="#"><i class="fa fa-edit fa-widget-edit"></i></a><a class="close-link widget-close"><i class="fa fa-close fa-widget-close"></i></a></div>',r[++o]="</div>",r[++o]="</div>",r[++o]='<div class="ibox-content">',r[++o]='<div class="svg-container" id="svg_',r[++o]=n,r[++o]='">',r[++o]="</div>",r[++o]="</div>",r[++o]="</div>",e("#chartrow").append(r.join("")),q("#c_"+n),n}function q(t){e(".close-link",t).click(function(){e(this).closest(".aChart").remove()}),e(".widget-close").off().click(function(){var t,n,a,r=e(this);for(n=r.closest(".aChart").attr("id"),a=n.substr(2),e("#"+n).remove(),t=0;t<Z.length;t++)if(Z[t].id===a){Z.splice(t,1),saveToServer(Z);break}}),e(".widget-edit").off().click(function(){var t,n,r,o=e(this);c.select(o.closest(".aChart")),gTasks.cache.surveyConfig[a.gViewId].filtered,o.data("ctype");for(n=o.closest(".aChart").attr("id"),r=n.substr(2),F=B[r],z=!1,t=0;t<Z.length;t++)if(Z[t].id===r){Q=Z[t];break}"completion_time"!==Q.name&&"periodic_count"!==Q.name||(Q.time_interval=!0),C(),e("#editChart").modal("show")})}function C(){var t,n;gTasks.cachecurrentData.schema.columns;e("#ew_tseries").prop("checked",Q.tSeries),e("#ew_qlabel").prop("checked",Q.qlabel),e("#ew_chart_type").val(Q.chart_type),e("#ew_title").val(Q.title),e("#ew_width").val(Q.width),e("#ew_fn").val(Q.fn),Q.groups&&Q.groups.length>0&&(t=Q.groups[0].qIdx,e("#ew_question1").val(t),Q.groups.length>1&&(n=Q.groups[1].qIdx,e("#ew_question2").val(n))),e("#ew_period").val(Q.period),T(t,n,Q.chart_type),x(),L()}function T(e,t,n){D(),S(n),I(e,t),x()}function x(){var t,n,r=(gTasks.cachecurrentData.schema.columns,e("#ew_question1").val()),o=!1,s=!1,i="",l=[],c=-1;for(void 0!==gTasks.cache.surveyConfig[a.gViewId].columns[r]&&(i=gTasks.cache.surveyConfig[a.gViewId].columns[r].type),"duration"===i||"int"===i||"decimal"===i?o=!0:s=!0,t=0;t<H.length;t++)(o&&H[t].numeric||s&&H[t].nonNumeric)&&(void 0===n&&(n=H[t].fn),l[++c]='<option value="',l[++c]=H[t].fn,l[++c]='">',l[++c]=localise.set[H[t].fn],l[++c]="</option>");e("#ew_fn").empty().append(l.join("")),e("#ew_fn").val(n)}function D(){var t=e("#ew_tseries").prop("checked");void 0!==t&&(t?e(".tseries_only, .period_only").show():e(".tseries_only, .period_only").hide())}function S(t){var n,a=e("#ew_tseries").prop("checked"),r=[],o=-1;for(n in A)if(A.hasOwnProperty(n)){if(a){if(!A[n].tseries)continue}else if(!A[n].non_tseries)continue;void 0===t&&(t=n),r[++o]='<option value="',r[++o]=n,r[++o]='"',t===n&&(r[++o]=" selected"),r[++o]=">",r[++o]=localise.set[n],r[++o]="</option>"}e(".chart_type").empty().append(r.join(""))}function L(){var t=e("#ew_chart_type").val(),n=e("#ew_fn").val();"wordcloud"===t||"pie"===t&&"count"===n?(O("ew_question2"),O("ew_fn")):(j("ew_question2"),j("ew_fn"))}function I(t,n){var a,r,o=e("#ew_tseries").prop("checked"),s=gTasks.cache.currentData.schema.columns,i=[],l=-1;if(o)for(a=0;a<s.length;a++)"dateTime"!==s[a].type&&"date"!==s[a].type||(i[++l]='<option value="',i[++l]=a,i[++l]='">',i[++l]=s[a].displayName,i[++l]="</option>");else for(a=0;a<s.length;a++)s[a].chartQuestion&&(void 0===r&&(r=a),i[++l]='<option value="',i[++l]=a,i[++l]='">',i[++l]=s[a].select_name?s[a].select_name:s[a].displayName,i[++l]="</option>");e(".question_req").empty().append(i.join("")),e(".question").empty().append(V),e(".question").append(i.join("")),e("#ew_question1").val(t),e("#ew_question2").val(n)}function E(){var t,n,a,r,o,s=(e("#ew_width").val(),!0),i=gTasks.cache.currentData.schema.columns,l=Q.width,c=e("#ew_title").val();if(c&&0!==c.trim().length||(s=!1,t=localise.set.mf_tr),s){if(a=e("#ew_question1").val(),e("#ew_question2").prop("disabled")||(r=e("#ew_question2").val()),Q.groups=[],Q.fn=e("#ew_fn").val(),Q.title=c,Q.tSeries=e("#ew_tseries").prop("checked"),Q.qlabel=e("#ew_qlabel").prop("checked"),Q.chart_type=e("#ew_chart_type").val(),Q.width=e("#ew_width").val(),Q.period=e("#ew_period").val(),void 0!==a&&i&&i[a]&&(o={qIdx:a,type:i[a].type,name:i[a].select_name?i[a].select_name:i[a].displayName,dataLabel:i[a].select_name?i[a].select_name:i[a].displayName,l_id:i[a].l_id,choices:i[a].choices,choiceNames:i[a].choiceNames},Q.groups.push(o)),void 0!==r&&i&&i[r]&&(o={qIdx:r,type:i[r].type,name:i[r].select_name?i[r].select_name:i[r].displayName,dataLabel:i[r].select_name?i[r].select_name:i[r].displayName,l_id:i[r].l_id,choices:i[r].choices,choiceNames:i[r].choiceNames},Q.groups.push(o)),Q.tSeries){e("#ew_period").val()!=Q.period&&!0,Q.period=e("#ew_period").val()}var u=!1;for(n=0;n<Z.length;n++)if(Z[n].id===Q.id){Z.splice(n,1,Q),u=!0;break}u||Z.push(Q),e("#editChart").modal("hide"),Q.width===l?m(Q,!1):f(!0,!1,!0)}else e("#chartInfo").show().removeClass("alert-success").addClass("alert-danger").html(t)}function Y(){Q=e.extend(!0,{},X),z=!0,C(),e("#editChart").modal("show")}function O(t){e("#"+t).prop("disabled","disabled")}function j(t){e("#"+t).prop("disabled",!1)}function M(e,t){var n,a,r,o=gTasks.cache.currentData.schema.choiceLists;if(0!=e)for(a=0;a<o.length;a++)if(o[a].l_id==e){for(n=o[a],r=0;r<n.choices.length;r++)if(n.choices[r].k==t)return n.choices[r].v;break}return t}function P(t){return"decimal"===t||"int"===t||"duration"===t?e("#srf_num_fn").val():e("#srf_text_fn").val()}var V,F,Q,z,A={bar_h:{draw:r,tseries:!0,non_tseries:!0},bar_v:{draw:o,tseries:!0,non_tseries:!0},pie:{draw:s,tseries:!1,non_tseries:!0},line:{draw:i,tseries:!0,non_tseries:!1},wordcloud:{draw:l,tseries:!1,non_tseries:!0}},H=[{fn:"count",numeric:!1,nonNumeric:!0},{fn:"average",numeric:!0,nonNumeric:!1},{fn:"max",numeric:!0,nonNumeric:!1},{fn:"min",numeric:!0,nonNumeric:!1},{fn:"sum",numeric:!0,nonNumeric:!1}],X={groups:[],time_interval:!1,title:"",chart_type:"bar_h",group:"none",fn:"count",tSeries:!1,period:void 0,width:12},Z=[],B={},G=!0,J=!0,K=!1;return{init:h,setCharts:d,refreshAllCharts:f,addNewChart:Y,getXLSData:p}});