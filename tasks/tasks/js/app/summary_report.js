/*
 This file is part of SMAP.

 SMAP is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 uSMAP is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with SMAP.  If not, see <http://www.gnu.org/licenses/>.

 */

define(["jquery","modernizr","localise","globals"],function(e,n,r,a){function t(n){var r,t,o,i,p=a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data(),f=[],g=p.count(),h=[];if(n){var m=gTasks.cache.currentData.schema.columns;for(r=0;r<m.length;r++)if(m[r].chartQuestion){if(o={title:m[r].select_name?m[r].select_name:m[r].displayName,tSeries:!1,chart_type:"other",fn:l(m[r].type),groups:[{name:m[r].select_name?m[r].select_name:m[r].displayName,dataLabel:m[r].select_name?m[r].select_name:m[r].displayName,l_id:m[r].l_id,type:m[r].type}]},"select"===m[r].type&&(o.groups[0].choiceNames=m[r].choiceNames,o.groups[0].choices=m[r].choices),(i=e("#srf_group").val())==r)continue;-1!=i&&(o.groups.push({name:m[i].select_name?m[i].select_name:m[i].displayName,dataLabel:m[i].select_name?m[i].select_name:m[i].displayName,l_id:m[i].l_id,type:m[i].type}),"select"!==m[i].type&&"select1"!==m[i].type||(o.groups[1].choiceNames=m[i].choiceNames,o.groups[1].choices=m[i].choices)),f.push(o)}}else f=c;for(r=0;r<f.length;r++)o=f[r],t=s(p,o,g),u(h,o,t);return h}function u(e,n,r){var a,t,u,s,o=[];if(n.tSeries)a=r,!0;else if("wordcloud"===n.chart_type){!0;for(var l in r)r.hasOwnProperty(l)&&o.push({key:l,pr:[{key:n.groups[0].dataLabel,value:r[l]}]})}else{var c=r.length;if("percent"===n.fn&&0===c)return;var i={};if("percent"===n.fn){var p=d3.nest().key(function(e){return e[n.groups[1].name]}).rollup(function(e){return e.length}).entries(r);for(t=0;t<p.length;t++)i["x"+p[t].key]=p[t].value}if(1===n.groups.length)a="count"===n.fn||"percent"===n.fn?d3.nest().key(function(e){return e[n.groups[0].name]}).rollup(function(e){return"count"===n.fn?e.length:100*e.length/c}).entries(r):d3.nest().key(function(e){return n.groups[0].name}).rollup(function(e){return"average"===n.fn?d3.mean(e,function(e){return+e[n.groups[0].name]}):"sum"===n.fn?d3.sum(e,function(e){return+e[n.groups[0].name]}):"min"===n.fn?d3.min(e,function(e){return+e[n.groups[0].name]}):"max"===n.fn?d3.max(e,function(e){return+e[n.groups[0].name]}):void 0}).entries(r);else if("count"===n.fn||"percent"===n.fn){if(a=d3.nest().key(function(e){return e[n.groups[0].name]}).key(function(e){return e[n.groups[1].name]}).rollup(function(e){return e.length}).entries(r),"percent"===n.fn)for(t=0;t<a.length;t++)for(u=0;u<a[t].values.length;u++)0==i["x"+a[t].values[u].key]?a[t].values[u].value=0:a[t].values[u].value=100*a[t].values[u].value/i["x"+a[t].values[u].key]}else a=d3.nest().key(function(e){return e[n.groups[1].name]}).rollup(function(e){return"average"===n.fn?d3.mean(e,function(e){return+e[n.groups[0].name]}):"sum"===n.fn?d3.sum(e,function(e){return+e[n.groups[0].name]}):"min"===n.fn?d3.min(e,function(e){return+e[n.groups[0].name]}):"max"===n.fn?d3.max(e,function(e){return+e[n.groups[0].name]}):void 0}).entries(r);var f=[];for(t=0;t<n.groups.length;t++)f.push(n.groups[t].dataLabel);var g=[];if(2===n.groups.length&&("count"===n.fn||"percent"===n.fn))for(t=0;t<a.length;t++)for(u=0;u<a[t].values.length;u++){var h=a[t].values[u].key;g.indexOf(h)<0&&g.push(h)}for(t=0;t<a.length;t++){var m={key:a[t].key,pr:[]};if((1===n.groups.length||"count"!==n.fn&&"percent"!==n.fn)&&m.pr.push({key:n.fn,value:a[t].value}),2===n.groups.length)for(u=0;u<g.length;u++){var v=!1;for(s=0;s<a[t].values.length;s++)if(a[t].values[s].key===g[u]){m.pr.push({key:g[u],value:a[t].values[s].value}),v=!0;break}v||m.pr.push({key:g[u],value:0})}o.push(m)}}var d={chart_type:n.chart_type,name:n.title,fn:n.fn,labels:f,columns:g,data:o};e.push(d)}function s(e,n,r){var a,t,u=gTasks.cache.currentData.schema.columns,s=n.qlabel?"label":"name";if(gTasks.cache.surveyConfig.processedData||(gTasks.cache.surveyConfig.processedData={}),"select"===n.groups[0].type||n.groups.length>1&&"select"===n.groups[1].type)return o(e,n,r);if(!gTasks.cache.surveyConfig.processedData[s])for(gTasks.cache.surveyConfig.processedData[s]=[],a=0;a<e.length;a++){var l={};for(l.count=1,t=0;t<u.length;t++){var c=e[a][u[t].column_name];u[t].l_id>0&&n.qlabel&&(c=lookupChoiceLabel(u[t].l_id,c)),l[u[t].displayName]=c}l["Survey Duration"]||(l["Survey Duration"]=0),l["Survey Duration"]=+l["Survey Duration"],gTasks.cache.surveyConfig.processedData[s].push(l)}return gTasks.cache.surveyConfig.processedData[s]}function o(e,n,r){var a,t,u,s,o,l,c,i=[];n.groups,"select"==n.groups[0].type?(u=n.groups[0],n.groups.length>0&&(s=n.groups[1])):(s=n.groups[0],u=n.groups[1]);var p=gTasks.cache.currentData.schema.choiceLists;for(a=0;a<p.length;a++)if(p[a].l_id==u.l_id){p[a].choices;break}for(a=0;a<e.length;a++)if(e[a][u.dataLabel])for(c=e[a][u.dataLabel].split(" "),t=0;t<c.length;t++)o={count:1},l=n.qlabel?lookupChoiceLabel(u.l_id,c[t]):c[t],o[u.dataLabel]=l,s&&(o[s.dataLabel]=e[a][s.dataLabel]),i.push(o);return i}function l(n){return"decimal"===n||"int"===n||"duration"===n?e("#srf_num_fn").val():e("#srf_text_fn").val()}var c=[];return{getXLSData:t}});