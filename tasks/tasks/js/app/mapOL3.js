/*
 This file is part of SMAP.

 SMAP is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 uSMAP is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with SMAP.  If not, see <http://www.gnu.org/licenses/>.

 */

define(["jquery","modernizr","localise","globals","icheck"],function(e,t,o,a){function r(){if(_)for(i=0;i<_.length;i++)p(i)}function l(e,t){console.log("====== set layers: "),r(),_=e;var o={title:localise.set.c_data,local:!0,clump:void 0,enabled:!0,fixed:!0};_.length<2?_.push(o):_[0]=o,o={title:localise.set.c_heatmap,local:!0,clump:"heatmap",enabled:!1,fixed:!0},_.length<2?_.push(o):_[1]=o,n(t)}function n(t){var o,a=[],r=-1;for(o=0;o<_.length;o++)a[++r]="<tr>",a[++r]="<td>",a[++r]='<div class="switch custom-control custom-checkbox">',a[++r]='<input type="checkbox" class="custom-control-input layerSelect" name="columnSelect"',_[o].enabled&&(a[++r]='checked="checked"'),a[++r]=' value="',a[++r]=o,a[++r]='"',a[++r]=' id="layer'+o+'"',a[++r]=">",a[++r]='<label class="custom-control-label" for="layer'+o+'">',a[++r]=_[o].title,a[++r]="</label>",a[++r]="</div>",a[++r]="</td>",a[++r]="<td>",a[++r]='<button type="button" data-idx="',a[++r]=o,a[++r]='" class="btn btn-default btn-sm rm_layer danger"',_[o].fixed&&(a[++r]=" disabled"),a[++r]=">",a[++r]='<span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>',a[++r]="</td>",a[++r]="</tr>";e("#layerSelect tbody").empty().html(a.join("")),e(".rm_layer","#layerSelect tbody").click(function(){var t=e(this).data("idx");p(t),_.splice(t,1),n(S)}),e(".layerSelect").change(function(){var o=e(this),a=e(this).val();o.prop("checked")?g(a,t):u(a)})}function s(e,t){if(t){d(e,a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data(),t)}}function c(e,t){if(console.log("====== refresh all layers: "+e),e){if(t){var o,r=a.gMainTable.rows({order:"current",page:"all",search:"applied"}).data();for(o=0;o<_.length;o++)p(o),d(o,r,t)}k=!1}else k=!0}function d(e,t,o){var a=_[e],r=m(t,a);x[e]?x[e].clear():x[e]=new ol.source.Vector,x[e].addFeatures((new ol.format.GeoJSON).readFeatures(r,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),"heatmap"===a.clump?L[e]=new ol.layer.Heatmap({source:x[e],radius:5,id:"heatmap"}):L[e]=new ol.layer.Vector({source:x[e],style:window.gStyleFn,id:"base"}),a.enabled&&o.addLayer(L[e]),o.getView().fit(x[e].getExtent(),o.getSize())}function p(e){L[e]&&(S.removeLayer(L[e]),x.splice(e,1),L.splice(e,1))}function u(e){map.removeLayer(L[e])}function g(e,t){t.addLayer(L[e])}function y(t){var o=e("#ml_title").val(),a=e("#usecurrent_tabledata").is(":checked"),r={};if(void 0===o||0===o.trim().length)return e("#layerInfo").show().removeClass("alert-success").addClass("alert-danger").html(localise.set.mf_tr),!1;r.title=o,r.local=a,r.clump=e("input[name=clump]:checked","#mapForm").val(),_.push(r),e("#layerEdit").modal("hide"),s(_.length-1,t),n(t)}function m(e,t){var o,a,r,l,i={type:"FeatureCollection",features:[]};for(o=0;o<e.length;o++){var n=!1;if(e[o]._geolocation){if("Point"===e[o]._geolocation.type){for(a=1;a<e[o]._geolocation.coordinates.length;a++)if(0!=e[o]._geolocation.coordinates[a]){n=!0;break}}else if("LineString"===e[o]._geolocation.type){for(a=0;a<e[o]._geolocation.coordinates.length;a++)for(r=0;r<e[o]._geolocation.coordinates[a].length;r++)if(0!=e[o]._geolocation.coordinates[a][r]){n=!0;break}}else if("Polygon"===e[o]._geolocation.type)for(a=0;a<e[o]._geolocation.coordinates.length;a++)for(r=0;r<e[o]._geolocation.coordinates[a].length;r++)for(l=0;l<e[o]._geolocation.coordinates[a][r].length;l++)if(0!=e[o]._geolocation.coordinates[a][r][l]){n=!0;break}}else n=!1;n&&i.features.push({type:"Feature",geometry:e[o]._geolocation,properties:{record:o,main:!0,_assigned:e[o]._assigned}})}return i}function f(t){e.ajax({url:"/surveyKPI/shared/maps",dataType:"json",cache:!1,success:function(e){a.gSelector.setSharedMaps(e),h(t,e)},error:function(e,t,o){0!=e.readyState&&0!=e.status&&alert("Error: Failed to get list of shared maps: "+o)}})}function h(e,t){var o,r,l;if(t){var i=e.getLayers().item(0).getLayers().getArray();for(o=0;o<t.length;o++)l=t[o],"mapbox"===l.type&&(r="https://api.mapbox.com/styles/v1/"+l.config.mapid+"/tiles/{z}/{x}/{y}?access_token="+a.gMapboxDefault,i.unshift(new ol.layer.Tile({title:l.name,type:"base",visible:!1,source:new ol.source.OSM({url:r,crossOrigin:"anonymous"})})))}}function b(t,o,r,l){if(t.map)console.log("Map "+t.id+" already initialised");else{t.map=new ol.Map({target:t.id,layers:[new ol.layer.Group({title:"Base maps",layers:[new ol.layer.Tile({title:"HOT",type:"base",visible:!0,source:new ol.source.OSM({url:"http://{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"})}),new ol.layer.Tile({title:"OSM",type:"base",visible:!0,source:new ol.source.OSM})]})],view:new ol.View({center:ol.proj.transform([0,0],"EPSG:4326","EPSG:3857"),zoom:1,maxZoom:21})});var i=a.gSelector.getSharedMaps();i?h(t.map,i):getMapboxDefault(f,t.map);var s=[];if(t.currentValue){var d={type:"Feature",geometry:t.currentValue,properties:{type:t.readOnly?"current":"old",label:localise.set.c_to}};s.push(d)}if(t.readOnly&&t.oldValue){var p={type:"Feature",geometry:t.oldValue,properties:{type:"old",label:localise.set.c_from}};s.push(p)}var u={type:"FeatureCollection",features:s};if(window.gStyleFn=function(e,t){var o,r,l;return e.get("main")?(o=e.get("_assigned")===a.gLoggedInUser.ident?"rgba(0, 0, 255, 1.0)":""===e.get("_assigned")?"rgba(255, 165, 0, 1.0)":"rgba(255, 255, 255, 1.0)",l="rgba(255, 255, 255, 0.8)"):"current"===e.get("type")?(o="rgba(255, 0, 0, 1.0)",r="rgba(255, 100, 50, 0.3)",l="rgba(255, 10, 10, 0.8)"):"old"===e.get("type")?(o="rgba(0, 0, 255, 1.0)",r="rgba(50, 100, 255, 0.3)",l="rgba(10, 10, 255, 0.8)"):(o="rgba(0, 255, 255, 1.0)",r="rgba(10, 200, 255, 0.3)",l="rgba(10, 200, 255, 0.8)"),[new ol.style.Style({fill:new ol.style.Fill({color:r}),stroke:new ol.style.Stroke({width:2,color:l}),image:new ol.style.Circle({fill:new ol.style.Fill({color:o}),stroke:new ol.style.Stroke({width:2,color:"rgba(100, 100, 100, 0.8)"}),radius:7})})]},u.features.length>0){var g=new ol.source.Vector;try{g.addFeatures((new ol.format.GeoJSON).readFeatures(u,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}));var y=new ol.layer.Vector({source:g,style:gStyleFn});t.map.addLayer(y),t.map.getView().fit(g.getExtent(),t.map.getSize())}catch(e){}}var m=new ol.control.LayerSwitcher({tipLabel:"Legend"});if(t.map.addControl(m),o){t.geolocation=new ol.Geolocation({projection:t.map.getView().getProjection(),tracking:!0,trackingOptions:{enableHighAccuracy:!0,maximumAge:2e3}});var b=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,25],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:1,src:"/js/libs/OpenLayers/img/marker-gold.png"})}),w=new ol.Feature,_=new ol.source.Vector({features:[w]}),x=new ol.layer.Vector({source:_,style:b});t.map.addLayer(x),t.geolocation.on("change",function(){var e=t.geolocation.getPosition(),o=t.map.getView();w.setGeometry(new ol.geom.Point(e)),o.setCenter(e),o.setZoom(18)})}l?t.map.on("click",function(o){if(e("#features").hide().empty(),r){var a=[];t.map.forEachFeatureAtPixel(o.pixel,function(e,t){a.push(e.getProperties())}),r(a)}}):t.map.on("click",function(o){var a=!0,l=t.id,i=e("#tooltip_"+l);if(t.map.forEachFeatureAtPixel(o.pixel,function(e,t){var l=e.getProperties();i.html(l.label),i.css({position:"absolute",left:o.pixel[0],top:o.pixel[1],"z-index":2e4,"background-color":"white",padding:2}).show(),a=!1,r&&r(l)}),a&&(i.hide(),!t.readOnly)){var n=ol.proj.transform(o.coordinate,"EPSG:900913","EPSG:4326"),s={itemIndex:e("#"+l).data("item"),value:{coordinates:n,type:"Point"}};t.task?e("#taskPropertiesForm").trigger("smap_task::geopoint",s):s.itemIndex&&e("#editRecordForm").trigger("smap::geopoint",s),v(t,o.coordinate,void 0,void 0,!1)}}),l&&(S=t.map,n(t.map),e("#showlayers").click(function(){a.gMapLayersShown=!a.gMapLayersShown,a.gMapLayersShown?(e("#map_content").removeClass("col-md-12").addClass("col-md-8"),e(".map_layers").show(),S.updateSize()):(e("#map_content").removeClass("col-md-8").addClass("col-md-12"),e(".map_layers").hide(),S.updateSize())}))}l&&k&&c(!0,t.map)}function w(e){e.selectSource&&(e.selectSource.clear(),e.map.removeLayer(e.selectLayer),e.selectGeometry=void 0,e.selectSource=void 0,e.selectLayer=void 0)}function v(e,t,o,a,r){if(!t){var l=[];l.push(o),l.push(a),t=ol.proj.transform(l,"EPSG:4326","EPSG:900913")}if(void 0!==e.selectLayer)e.selectGeometry.setCoordinates(t);else{e.selectGeometry=new ol.geom.Point(t);var i=new ol.Feature({geometry:e.selectGeometry,type:"current",label:localise.set.c_to});e.selectSource=new ol.source.Vector({features:[i]}),e.selectLayer=new ol.layer.Vector({source:e.selectSource,style:gStyleFn}),e.map.addLayer(e.selectLayer)}r&&e.map.getView().fit(e.selectSource.getExtent(),e.map.getSize())}var S,_=[],x=[],L=[],k=!0;return{setLayers:l,refreshLayer:s,refreshAllLayers:c,saveLayer:y,deleteLayers:r,initDynamicMap:b,clearSelectFeatures:w,setSelectedFeature:v}});