/*
 This file is part of SMAP.

 SMAP is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.
 uSMAP is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with SMAP.  If not, see <http://www.gnu.org/licenses/>.

 */

define(["jquery","common","modernizr","localise","globals","app/mapOL3","multiselect"],function(e,t,a,l,s,n){function r(e,t,a,l){var s=e.columns,n=s[a];for(i=0;i<s.length;i++){var r=s[i];if(r.mgmt&&("select1"===r.type||"select"===r.type||"select_one"===r.type)){var o=t[r.column_name];u(e,r,i,o,t,n.column_name,l)}}}function o(t,a,l,i,n,o){var c,p,u=[],f=-1,m=[],g=-1,v=!0,y=a.columns;for(s.gRecordMaps=[],gTasks.gPriKey=t.prikey,gTasks.gUpdate=[],e(".saverecord").prop("disabled",!0),c=0;c<y.length;c++)p=y[c],p.mgmt&&(u[++f]=d(p,c,v,t,a,n,!0,"er")),m[++g]=d(p,c,v,t,a,!1,!0,"er"),p.readonly||(v=!1);l&&l.html(u.join("")),i&&i.html(m.join("")),l.find(".date").datetimepicker({locale:gUserLocale||"en",useCurrent:!1,showTodayButton:!0}),e(".select",l).multiselect({onChange:function(e,t,a){var l=e.closest("select"),s=l.data("item"),i="";l.val()&&(i=l.val().join(" ")),h({itemIndex:s,value:i})}}),o&&k(s.gRecordMaps),l.find(".form-control, select").bind("click propertychange paste change keyup input",function(){if(!e(this).hasClass("select")){var l=e(this);h({itemIndex:l.data("item"),value:l.val()}),r(a,t,l.data("item"),"er")}}),l.find(".date").on("dp.change",function(){var t=e(this).find("input");h({itemIndex:t.data("item"),value:t.val()})}),e("#editRecordForm").on("smap::geopoint",function(e,t){console.log("New geopoint"),h(t)}),l.find("[autofocus]").focus()}function c(t,a,l){var s,i,n=[],o=-1,c=!0,p=a.columns;for(s=0;s<p.length;s++){if(i=p[s],i.mgmt){n[++o]='<div class="row bulkquestion">',n[++o]='<div class="col-sm-8">';var u=JSON.parse(JSON.stringify(i));"select"===i.type&&(u.type="select1"),n[++o]=d(u,s,c,t,a,!0,!1,"be"),n[++o]="</div>",n[++o]='<div class="col-sm-4">',"select"===i.type&&(n[++o]='<div class="switch">',n[++o]='<input type="checkbox" class="selectClear">',n[++o]="</div>"),n[++o]="</div>",n[++o]="</div>"}i.readonly||(c=!1)}l&&l.html(n.join("")),l.find(".date").datetimepicker({locale:gUserLocale||"en",useCurrent:!1,showTodayButton:!0}),l.find(".form-control, select").bind("click propertychange paste change keyup input",function(){var l=e(this);y({itemIndex:l.data("item"),value:l.val(),clear:l.closest(".bulkquestion").find(".selectClear").is(":checked")}),r(a,t,l.data("item"),"be")}),l.find(".selectClear").bind("change",function(){var l=e(this),s=l.closest(".bulkquestion").find(".form-control");y({itemIndex:s.data("item"),value:s.val(),clear:l.is(":checked")}),r(a,t,l.data("item"),"be")}),l.find("[autofocus]").focus()}function d(e,t,a,l,i,n,r,o){var c,d=[],u=-1;if(l&&r){c=l[e.column_name]}return d[++u]='<div class="form-group row"><label class="col-md-4 control-label">',d[++u]=htmlEncode(e.displayName),d[++u]="</label>",d[++u]=' <div class="col-md-8">',"geopoint"===e.type||"geoshape"===e.type||"geotrace"===e.type?d[++u]=m(e.readonly||!n,"record_maps_",s.gRecordMaps,e,c,void 0,t):e.readonly||!n?d[++u]=_(c):(d[++u]=p(e,c,t,a,i,l,o),a=!1),d[++u]="</div>",d[++u]="</div>",d.join("")}function p(e,t,a,l,s,i,n){var r,o=[],c=-1;if(e.parameters&&e.parameters.source)var r=g(e.parameters.source,s.columns);if(r&&(o[++c]=v(r,i,e.parameters.rows)),"decimal"===e.type||"integer"===e.type||"int"===e.type)o[++c]=' <input type="number"',"integer"!==e.type&&"int"!==e.type||(o[++c]=' step="1"'),o[++c]=' class="form-control editable" value="',o[++c]=t,o[++c]='" data-item="',o[++c]=a,o[++c]=l?'" autofocus/>':'"/>';else if("date"===e.type)o[++c]='<div class="input-group date" data-container="body">',o[++c]='<input type="text" class="form-control editable" data-date-format="YYYY-MM-DD" value="',o[++c]=t,o[++c]='" data-item="',o[++c]=a,o[++c]=l?'" autofocus/>':'"/>',o[++c]='<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>',o[++c]="</div>";else if("select1"===e.type||"select"===e.type||"select_one"===e.type){o[++c]=' <select id="select_',o[++c]=n+a,o[++c]='" class="form-control editable ',"select"===e.type&&(o[++c]=" select"),o[++c]='" data-item="',o[++c]=a,o[++c]='"',"select"===e.type&&(o[++c]=' multiple="multiple"'),o[++c]=">","select"!==e.type&&(o[++c]='<option value=""></option>');var d=u(s,e,a,t,i,void 0,n);d&&(o[++c]=b(e,d,t,!0)),o[++c]="</select>"}else{var p=addAnchors(t)[0];p&&0==p.indexOf("<")?o[++c]=p:e.parameters&&e.parameters.rows?(o[++c]=" <textarea rows=",o[++c]=e.parameters.rows,o[++c]=' class="form-control editable" ',o[++c]='" data-item="',o[++c]=a,o[++c]=l?'" autofocus>':'">',o[++c]=t,o[++c]="</textarea>"):(o[++c]=' <input type="text"',o[++c]='" class="form-control editable" value="',o[++c]=t,o[++c]='" data-item="',o[++c]=a,o[++c]=l?'" autofocus/>':'"/>')}return o.join("")}function u(t,a,l,i,n,r,o){var c,d,p=a.l_id;if(t&&t.choiceLists&&t.choiceLists.length)for(c=0;c<t.choiceLists.length;c++)if(t.choiceLists[c].l_id===p){d=t.choiceLists[c].choices;break}if(d&&d.length>0){if(!a.appearance||!(a.appearance.indexOf("search(")>=0||a.appearance.indexOf("lookup_choices(")>=0))return d;var u,m=getAppearanceParams(a.appearance),g=!1,v=!1,h=!1;if(m.length>0){var y=s.gGroupSurveys[s.gCurrentSurvey],_=d[0].k,k=d[0].v,x="/lookup/choices/"+y+"/"+m.filename+"/"+_+"/"+k;if(void 0!==m.filter)if("eval"===m.filter){if(void 0!==m.expression){const T=/\$\{.+?\}/g,U=m.expression.match(T);if(U&&U.length>0)for(c=0;c<U.length;c++){var O=U[c];u=O.substring(2,O.length-1);var w=n[u];w=f(u,w);var j=getQuestionType(t,u);"int"!==j&&(w="'"+w+"'"),m.expression=m.expression.replace(O,w),r&&u===r&&(h=!0)}var N=encodeURIComponent(m.expression);N=N.replace(/\(/g,"%28"),N=N.replace(/\)/g,"%29"),x+="?expression="+N}}else void 0!==m.filter_column&&void 0!==m.filter_value&&(x+="?search_type="+m.filter,x+="&q_column="+m.filter_column,0==m.filter_value.indexOf("${")&&(u=m.filter_value.substring(2,m.filter_value.length-1),m.filter_value=n[u],m.filter_value=f(m.filter_column,m.filter_value),r&&u===r&&(g=!0)),x+="&q_value="+m.filter_value,void 0!==m.second_filter_column&&void 0!==m.second_filter_value&&(x+="&f_column="+m.second_filter_column,0==m.second_filter_value.indexOf("${")&&(u=m.second_filter_value.substring(2,m.second_filter_value.length-1),m.second_filter_value=n[u],m.second_filter_value=f(m.second_filter_column,m.second_filter_value),r&&u===r&&(v=!0)),x+="&f_value="+m.second_filter_value));(!r||g||v||h)&&e.ajax({url:x,cache:!1,success:function(t,s){var n="#select_"+o+l,r=i,c=b(a,t,r,!1);e(n).empty().append(c),"select"===a.type&&e(n).multiselect("rebuild")},error:function(e,t){alert("Error: "+e.responseText)}})}else alert("invalid search for: "+a.question_name)}}function f(e,t){if(gTasks.gUpdate&&gTasks.gUpdate.length>0){var a;for(a=0;a<gTasks.gUpdate.length;a++)if(gTasks.gUpdate[a].name===e)return gTasks.gUpdate[a].value}return t}function m(e,t,a,l,s,i,n){var r=[],o=-1;if("string"==typeof s)try{s=JSON.parse(s)}catch(e){}if("string"==typeof i)try{i=JSON.parse(i)}catch(e){}var c={readOnly:e,id:t+a.length,currentValue:s,oldValue:i};return r[++o]='<div id="',r[++o]=c.id,r[++o]='" data-item="',r[++o]=n,r[++o]='" class="small_map">',r[++o]='<div id="tooltip_',r[++o]=c.id,r[++o]='"></div>',r[++o]="</div>",a.push(c),r.join("")}function g(e,t){var a,l;for(a=0;a<t.length;a++)if(t[a].mgmt&&e===t[a].name||!t[a].mgmt&&e===t[a].displayName){l=t[a];break}return l}function v(e,t,a){var l=e.mgmt?e.name:e.column_name,s=addAnchors(t[l])[0],i=[],n=-1;return 0==s.indexOf("<")?i[++n]=s:((!a||a<=1)&&(a=1),i[++n]=' <textarea readonly style="overflow-y:scroll;" rows=',i[++n]=a,i[++n]=' class="form-control">',i[++n]=s,i[++n]="</textarea>"),i.join("")}function h(t){var a,l,s,i=t.itemIndex,n=t.value,r=gTasks.gSelectedRecord,o=gTasks.cache.currentData.schema.columns,c=o[i].column_name,d=o[i].displayName;if(a=r[c],void 0===a&&(a=""),"object"==typeof a&&(a=JSON.stringify(a)),"object"==typeof n&&(n=JSON.stringify(n)),a!==n){for(s=!1,l=0;l<gTasks.gUpdate.length;l++)if(gTasks.gUpdate[l].name===c){s=!0,gTasks.gUpdate[l].value=n;break}s||gTasks.gUpdate.push({name:c,displayName:d,value:n,currentValue:a,itemIndex:i})}else for(l=0;l<gTasks.gUpdate.length;l++)if(gTasks.gUpdate[l].name===c){gTasks.gUpdate.splice(l,1);break}gTasks.gUpdate.length>0?e(".saverecord").prop("disabled",!1):e(".saverecord").prop("disabled",!0),e(".re_alert").hide()}function y(t){var a,l,s=t.itemIndex,i=t.value,n=t.clear,r=gTasks.cache.currentData.schema.columns,o=r[s].column_name,c=r[s].displayName;for("object"==typeof i&&(i=JSON.stringify(i)),l=!1,a=0;a<gTasks.gUpdate.length;a++)if(gTasks.gUpdate[a].name===o){l=!0,gTasks.gUpdate[a].value=i,gTasks.gUpdate[a].clear=n;break}l||gTasks.gUpdate.push({name:o,displayName:c,value:i,clear:n,itemIndex:s}),gTasks.gUpdate.length>0?e(".saverecord").prop("disabled",!1):e(".saveRecord").prop("disabled",!0),e(".re_alert").hide()}function _(e){var t=addAnchors(e)[0],a=[],l=-1;return t&&0==t.indexOf("<")?a[++l]=t:(a[++l]=' <textarea readonly style="overflow-y:scroll;" rows=1',a[++l]=' class="form-control">',a[++l]=t,a[++l]="</textarea>"),a.join("")}function k(e,t){var a;for(a=0;a<e.length;a++)t&&t!==e[a].id||n.initDynamicMap(e[a])}function b(e,t,a,l){var s,i,n,r,o=-1,c=[];for("select"===e.type?i=a.split(" "):c[++o]='<option value=""></option>',s=0;s<t.length;s++)l?(n=t[s].k,r=t[s].v):(n=t[s].value,r=t[s].labelInnerText),c[++o]="<option","select"===e.type?i.indexOf(n)>-1&&(c[++o]=' selected="selected"'):n===a&&(c[++o]=' selected="selected"'),c[++o]=' value="',c[++o]=n,c[++o]='">',c[++o]=r,c[++o]="</option>";return c.join("")}return{showEditRecordForm:o,showBulkEditForm:c,addCellMarkup:_,addCellMap:m,initialiseDynamicMaps:k}});